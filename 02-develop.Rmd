# Model Use and Develop {#develop}

![](fig/EDHM_manual.png)

## Basic Use of a complete MODELL

### RUn a MODEL

The using of a MODEL will summarized as four step:

![](fig/EDHM_model_wf.png)

1. Get the InData & Param list by run `Data_MODEL.XXX` in R, the list of "Data_" is structured as:

![](fig/EDHM_data_.png)


2. Prepare the data and transfer into EDHM form and confirm a parameter set. 

Please must mark the time-variable and time-invariable VARIABLEs.

Please use `Data_XXX$InData$GROUP$VARIABLE` check the VARIABLE structure, when the VARIABLE is not normal.

3. Input the prepared data to InData and Param. 

For the time-variable VARIBLE must put into "TimeVari", some like "VARIABLE 1, 2" belong to "GROUP 1" and time-variable, "VARIABLE 3" belong to also "GROUP 1" but time-invariable. Then they will be structured as:

![](fig/EDHM_vari.png)

The code for this exemple like:
```{}
TimeVari <- t_vari.hm.list()
TimeVari$GROUP1$VARIABLE1 <- mydata1
TimeVari$GROUP1$VARIABLE2 <- mydata2
TimeVari$GROUP2$VARIABLE4 <- mydata3

TimeInVari <- hm.list()
TimeInVari$GROUP1$VARIABLE3 <- mydata4

Param <- list()
Param$Paramter1 <- myparam1
Param$Paramter2 <- myparam2
```

4. Run the MODEL.
```{}
my_simu <- MODELL.XXX(TimeVari, TimeInVari, Param)
```


### set a Run_MODEL

In EDHM the parameters are index with the parameters name, but when we calibrate the parameters, we set the parameters in a vector, also for some research not all of the parameters need to calibrate, so there is a setting about parameters from vector transfer to list.

There shows the function `Run_MODEL.SERR`:

```{r}
Run_Model.SERR <- function(TimeVariData, TimeInvariData, Param,
                           ParamterCalibrate){
  ## 1.0 snow##
  Param$Max_Snow_T = ParamterCalibrate[1]
  Param$Min_Snow_T = ParamterCalibrate[2]
  Param$Factor_Day_degree = ParamterCalibrate[3]  ## 2.7-12 [mm]
  Param$Base_T = ParamterCalibrate[4]  ## -2-5.5 [Cel]
  ## 1.1 ET ##
  Param$CanopyCapacity = ParamterCalibrate[5]
  Param$Coeff_ET_Capacity_Attenuat = ParamterCalibrate[6]
  ## 1.2 Runoff ##
  Param$Threshold_Runoff = ParamterCalibrate[7]
  Param$Ratio_Runoff = ParamterCalibrate[8]
  Param$Ratio_GW_Storage = ParamterCalibrate[9]
  Param$Coeff_GW_Storage_Attenuat = ParamterCalibrate[10]
  ## 1.3 Route ##
  Param$UPPaList = ParamterCalibrate[11:17]

  Result_ <- MODEL.SERR(TimeVariData, TimeInvariData, Param)
  Result <- Result_$Route$StaFlow
  return(Result)
}
```

The workflow is show in the following figure:

![](fig/EDHM_run_model_wf.png)


### Evaluate

Usually bye EVALUTE evalute the simulation results, but when we kalibrate the parameters, the EVALUTE evalute actully the parameters, those need to calibrate, so the EVALUTE based on the Run_MODEL.

The data flow is show in the following figure:

![](fig/EDHM_evalute_wf.png)

The EVALUTE functions is very easy to code, and the R Package ***hydroGOF*** [@R-hydroGOF] is also recommend, in that there are some commen evalute methods for hydrological field, some like *NSE*, *KGE*, *mae* and soon.

### Calibrate

The CALIBRATE help us choose the best parameter-set from a range, CALIBRATE will by the goodness of evaluate results and some algorithms to choose the parameters, at the end of algorithms find the best parameters-set, the "it" thinks.

The R package ***mcga*** [@R-mcga] is recommend, it is a Machine coded genetic algorithm to calibrate multi-parameters problem.

The data flow is show in the following figure:

![](fig/EDHM_calibrate_wf.png)

### Check the InData list

After the preparation of data must check the data, weather there is NA or other unlogical data.

The check tools will provide in the fast future.

## Copuling a new Model with MODULE

Generally researcher design a model for a basin or some specific environment, so in a new research region, we can use one model, the designed for this kind of basin or watershed and calibrate the empirical parameters. But sometimes by the calibrate of parameters can also not solve the problem, so researcher need change some of process to promote the simulation. In EDHM researcher are can use many MODULEs to build a new MODEL. The available PROCESSes and MODELs is show in the [table](#module).



### Choose MODULE

### Set the Data-FLow

### Build the MODEL and Run_MODEL

## Design a new MODULE

### Method and Formula

### Coding the body

### Set In/OutData and Parameter


